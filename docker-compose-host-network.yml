version: '3.8'

services:
  # NGINX RTMP Server for seamless streaming (with host network mode)
  rtmp:
    image: tiangolo/nginx-rtmp:latest
    container_name: twitch_rtmp_server
    network_mode: "host"  # Use host network to avoid NAT issues
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped

  # Twitch Stream Manager Application
  stream_manager:
    build: .
    container_name: twitch_stream_manager
    ports:
      - "5000:5000"  # Web UI port
    volumes:
      - ./config.yml:/app/config.yml
      - ./media:/app/media
      - ./users.yml:/app/users.yml
    environment:
      - PYTHONUNBUFFERED=1
      - RTMP_HOST=localhost  # Use localhost since rtmp is on host network
    depends_on:
      - rtmp
    restart: unless-stopped
    networks:
      - twitch_network

networks:
  twitch_network:
    driver: bridge
