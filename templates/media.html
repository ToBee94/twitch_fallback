{% extends "base.html" %}

{% block title %}Medien-Galerie - Twitch Stream Manager{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 3px dashed #cbd5e0;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 30px;
    }

    .upload-area:hover {
        border-color: #667eea;
        background: #f7fafc;
    }

    .upload-area.dragover {
        border-color: #667eea;
        background: #edf2f7;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .media-item {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s;
        background: #f7fafc;
    }

    .media-item:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }

    .media-item.active {
        border-color: #48bb78;
        border-width: 3px;
        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    }

    .media-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #e2e8f0;
    }

    .media-info {
        padding: 15px;
    }

    .media-name {
        font-weight: 500;
        margin-bottom: 8px;
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .media-size {
        font-size: 12px;
        color: #718096;
        margin-bottom: 10px;
    }

    .media-actions {
        display: flex;
        gap: 8px;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 600;
        margin: 30px 0 15px 0;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .badge {
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background: #48bb78;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #718096;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Medien hochladen</h2>

    <div class="upload-area" id="uploadArea">
        <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*" multiple>
        <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
        <h3 style="font-size: 18px; margin-bottom: 10px; color: #333;">Dateien hier ablegen oder klicken zum Ausw√§hlen</h3>
        <p style="color: #718096; font-size: 14px;">Unterst√ºtzt: JPG, PNG, GIF, MP4, MOV, AVI, MKV, WEBM (max. 500 MB)</p>
    </div>

    <div id="uploadProgress" style="display: none;">
        <div style="background: #e2e8f0; border-radius: 10px; overflow: hidden; height: 30px; margin-bottom: 10px;">
            <div id="progressBar" style="background: #667eea; height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
        <p id="progressText" style="text-align: center; color: #718096; font-size: 14px;"></p>
    </div>
</div>

<div class="card">
    <h2>Medien-Galerie</h2>

    <div class="section-title">
        Bilder
        <span class="badge">{{ files.images|length }}</span>
    </div>

    {% if files.images %}
        <div class="media-grid">
            {% for image in files.images %}
            <div class="media-item {% if config.fallback_type == 'image' and config.fallback_image == image.path %}active{% endif %}" data-filename="{{ image.name }}">
                <img src="/{{ image.path }}" class="media-preview" alt="{{ image.name }}">
                <div class="media-info">
                    <div class="media-name" title="{{ image.name }}">{{ image.name }}</div>
                    <div class="media-size">{{ (image.size / 1024 / 1024)|round(2) }} MB</div>
                    <div class="media-actions">
                        <button class="btn btn-small btn-primary" onclick="setFallback('image', '{{ image.name }}')">
                            {% if config.fallback_type == 'image' and config.fallback_image == image.path %}
                                ‚úì Aktiv
                            {% else %}
                                Als Fallback
                            {% endif %}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteMedia('{{ image.name }}')">L√∂schen</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div style="font-size: 64px; margin-bottom: 15px;">üñºÔ∏è</div>
            <p>Keine Bilder vorhanden. Lade dein erstes Bild hoch!</p>
        </div>
    {% endif %}

    <div class="section-title" style="margin-top: 40px;">
        Videos
        <span class="badge">{{ files.videos|length }}</span>
    </div>

    {% if files.videos %}
        <div class="media-grid">
            {% for video in files.videos %}
            <div class="media-item {% if config.fallback_type == 'video' and config.fallback_video == video.path %}active{% endif %}" data-filename="{{ video.name }}">
                <video class="media-preview" muted>
                    <source src="/{{ video.path }}" type="video/mp4">
                </video>
                <div class="media-info">
                    <div class="media-name" title="{{ video.name }}">{{ video.name }}</div>
                    <div class="media-size">{{ (video.size / 1024 / 1024)|round(2) }} MB</div>
                    <div class="media-actions">
                        <button class="btn btn-small btn-primary" onclick="setFallback('video', '{{ video.name }}')">
                            {% if config.fallback_type == 'video' and config.fallback_video == video.path %}
                                ‚úì Aktiv
                            {% else %}
                                Als Fallback
                            {% endif %}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteMedia('{{ video.name }}')">L√∂schen</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div style="font-size: 64px; margin-bottom: 15px;">üé¨</div>
            <p>Keine Videos vorhanden. Lade dein erstes Video hoch!</p>
        </div>
    {% endif %}
</div>

<div id="message-container"></div>

{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const messageContainer = document.getElementById('message-container');

    // Click to upload
    uploadArea.addEventListener('click', () => fileInput.click());

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        uploadFiles(files);
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        uploadFiles(e.target.files);
    });

    function uploadFiles(files) {
        if (files.length === 0) return;

        uploadProgress.style.display = 'block';
        let uploadedCount = 0;
        const totalFiles = files.length;

        Array.from(files).forEach((file, index) => {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                uploadedCount++;
                const progress = (uploadedCount / totalFiles) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `${uploadedCount} von ${totalFiles} Dateien hochgeladen`;

                if (data.success) {
                    if (uploadedCount === totalFiles) {
                        showMessage(`${totalFiles} Datei(en) erfolgreich hochgeladen`, 'success');
                        setTimeout(() => location.reload(), 1500);
                    }
                } else {
                    showMessage(`Fehler beim Hochladen von ${file.name}: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showMessage(`Fehler beim Hochladen: ${error}`, 'error');
            });
        });
    }

    function setFallback(type, filename) {
        fetch('/api/set_fallback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ type, filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage(data.message, 'error');
            }
        });
    }

    function deleteMedia(filename) {
        if (!confirm(`M√∂chten Sie "${filename}" wirklich l√∂schen?`)) return;

        fetch('/api/delete_media', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage(data.message, 'error');
            }
        });
    }

    function showMessage(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
        messageContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        setTimeout(() => {
            messageContainer.innerHTML = '';
        }, 5000);
    }

    // Play video on hover
    document.querySelectorAll('video').forEach(video => {
        video.addEventListener('mouseenter', () => video.play());
        video.addEventListener('mouseleave', () => {
            video.pause();
            video.currentTime = 0;
        });
    });
</script>
{% endblock %}
